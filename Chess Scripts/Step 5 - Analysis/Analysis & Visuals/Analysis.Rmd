---
title: "Analysis"
output:
  pdf_document: default
date: '`r format(Sys.Date(), "%B %d, %Y")`'
---



The purpose of this document is to make use of the data stored within the `FIDE` data folder. 

Before beginning, we need to import several packages that help run the code below.

```{r, message= FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(cowplot)
library(scales)
library(knitr)
library(xts)
library(dygraphs)
library(foreach)
library(doParallel)
library(zoo) 
library(stringi)
library(gganimate)
library(lubridate)
```

`tidyverse` imports dplyr, tidyr and several other useful packages for data wrangling and manipulation.

`data.table` is used purely for speeding up imports.


# Access the data

The data is stored in a path we have to manipulate to get to.


```{r}
path = "~/GitHub/FIDE/Chess Scripts/Step 4 - Cleaning/Cleaned csvs/"
opts_knit$set(root.dir = path)
temp = list.files(path = path, pattern = "*.csv")
proper_temp <- paste(path, temp, sep = "")
```

# Create functions to rename datasets

Below, I define a few functions that help us rename the datasets eventually

```{r}
num <- function(x) match(tolower(x), tolower(month.abb))
month <- function(x){return(substr(x, 1, 3))}
add_zero <- function(x){if (x <= 9){x = paste("0", x, sep = "")}; return(x)}
```

# Get the month number of all of the files in the dataset

Below, I rename create the variables names when they are imported in memory.

```{r}
temp%>%
sapply(month)%>%
sapply(num)%>%
sapply(add_zero)%>%
paste("20", substr(temp, 4, 5), "-", ., "-", "01", sep = "")-> month_num

head(month_num)
```

We can see that the datasets correspond to dates on which the is recorded.

# Import a sample of datasets 

Due to the data being quite large, your RAM may be used heavily. 

I'll look to investigate if parallelizing `rbindlist()` is possible at some point. Please bear with the computation time.

```{r}

for(i in 1:length(proper_temp)) {
assign(month_num[i], fread(proper_temp[i], sep = "*", data.table = FALSE, 
                           strip.white = TRUE, blank.lines.skip = TRUE))
}

#statement below takes a very long time to run because of rbindlist()
FIDE <- mget(ls(pattern = "[0-9][0-9]-[0-9][0-9]"))%>%
        rbindlist(fill = TRUE)
        
rm(list=setdiff(ls(), c("FIDE")))

```



#write dataframe to folder

```{r}
# fwrite(FIDE, "FIDE.csv")
# FIDE <- fread("FIDE.csv", data.table = FALSE)
```

Now that we have the data in a more clean, usable format, it's time we analyzed it.



# Set up basic filters 

```{r}
Titles = c("CM", "WCM",  "WGM", "WFM", "IM", "FM", "WIM", "GM", "")
Titles_only = c("CM", "WCM",  "WGM", "WFM", "IM", "FM", "WIM", "GM")
Active = c("", "w")
Inactive = c("i", "wi")
```

# Irregular values by year

```{r,echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
FIDE%>%
filter(!Title %in% Titles | !Activity %in% c(Active, Inactive))%>%
group_by(Date_numeric)%>%
tally()%>%
arrange(-n)%>%
head(10)%>%
kable()
```


I'll look to address many of the values in the early datasets eventually. For now though, over 99.9% of the data is interpretable. 

# Player counts by Activity

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
Active_player <- FIDE%>%
                 filter(Activity %in% Active)%>%
                 group_by(Date_numeric)%>%
                 summarise(total_count = n(),
                           avg_rating = mean(Rating, na.rm = T),
                           sd_rating = sd(Rating, na.rm = T))%>%
                 mutate(gain_loss = c(NA, diff(total_count)))


Inactive_player <- FIDE%>%
                   filter(Activity %in% Inactive)%>%
                   group_by(Date_numeric)%>%
                   summarise(total_count = n(),
                             avg_rating = mean(Rating, na.rm = T),
                             sd_rating = sd(Rating, na.rm = T))%>%
                   mutate(gain_loss = c(NA, diff(total_count)))

All_players <- FIDE%>%
               filter(Activity %in% c(Active, Inactive))%>%
               group_by(Date_numeric)%>%
               summarise(total_count = n(),
               avg_rating = mean(Rating, na.rm = T),
               sd_rating = sd(Rating, na.rm = T))%>%
               mutate(gain_loss = c(NA, diff(total_count)))

All_countries <- FIDE%>%
                 filter(Activity %in% Active)%>%
                 group_by(Date_numeric, Country)%>%
                 summarise(total_count = n())

Country_diff <- All_countries%>%
                arrange(Country, Date_numeric)%>%
                group_by(Country)%>%
                mutate(Diff = total_count - lag(total_count))%>%
                filter(!is.na(Diff))


Notable <- Country_diff%>%
           filter(abs(Diff) > 500)%>%
           .$Country%>%
           unique()

w_old = c("WCM", "WFM", "WGM", "WIM")
w_new = rep("W Title", length(w_old))

FIDE%>%
filter(Title %in% Titles_only)%>%
group_by(Date_numeric, Title)%>%
tally()%>%
mutate(w_titles = c(w_new, Title)[match(Title, c(w_old, Title))])-> titled

titled%>%
group_by(Date_numeric, w_titles)%>%
summarise(n = sum(n)) -> titles_group

FIDE%>%
filter(Games > 0, Activity %in% Active)%>%
group_by(Date_numeric)%>%
summarise(n = n())%>%
mutate(roll = rollmean(n, k = 6, fill = NA))-> Games


strongest <- FIDE%>%
             filter(Date_numeric == max(Date_numeric), 
                    Activity %in% Active,
                    as.numeric(Age_Birthday) > 1900, 
                    as.numeric(Age_Birthday) < 2019,
                    Rating > 900, 
                    Rating < 3000)%>%
             transmute(Country, Age = 2020-as.numeric(Age_Birthday), Rating)


breaks <- seq(min(strongest$Age), max(strongest$Age), 15)
break_labels = paste(breaks[-length(breaks)], breaks[-1], sep = "-")

strongest <- strongest%>%
             mutate(Age_groups = cut(Age, 
                                    breaks=breaks, 
                                    include.lowest=TRUE, 
                                    right=FALSE, 
                                    labels=break_labels))%>%
             filter(!is.na(Age_groups))%>%
             group_by(Country, Age_groups)%>%
             summarise(count = n(), average_rating = mean(Rating)%>%round())%>%
             filter(count > 200)%>%
             arrange(Age_groups, -average_rating)%>%
             select(-count)%>%
             group_by(Age_groups)%>%
             top_n(n = 7)

titled <- FIDE%>%
          filter(Title %in% Titles_only, Date_numeric == max(Date_numeric))%>%
          group_by(Title, Country)%>%
          tally()%>%
          arrange(Title, -n)%>%
          group_by(Title)%>%
          top_n(n = 10)


dec19_titled <- FIDE%>%
                filter(Date_numeric == max(Date_numeric), 
                      Activity %in% Active)%>%
                select(Rating, Title, Age_Birthday, Womens_Title)%>%
                mutate(Age_Birthday = 2020 - as.numeric(Age_Birthday))%>%
                filter(Age_Birthday > 0, Age_Birthday < 120,
                      Rating > 950, !Title %in% c(""), Womens_Title == "")

```


# Total player count over time

```{r, warning=FALSE, message=FALSE, echo=FALSE, cache=TRUE}
ggplot(data = All_players, aes(x = Date_numeric, y = total_count)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("# of players")+
  theme_bw()+
  scale_y_continuous(labels = comma)-> p1

ggplot(data = All_players, aes(x = Date_numeric, y = gain_loss)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("# of gained/lost")+
  geom_line(aes(y = 0))+
  theme_bw()+
  scale_y_continuous(labels = comma) -> p2

ggplot(data = Active_player, aes(x = Date_numeric, y = total_count)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("# of actives")+
  # geom_segment(aes(x=as.Date("2004-06-01"), xend=as.Date("2008-06-01"), y=120000, yend=70000), 
  #              arrow = arrow(length = unit(.5, "cm")), size = 2)+
  # geom_segment(aes(x=as.Date("2004-06-01"), xend=as.Date("2002-02-01"), y=120000, yend=35000), 
  #              arrow = arrow(length = unit(.5, "cm")), size = 2)+ 
  # annotate("text", x = as.Date("2006-06-01"), y = 130000, 
  #          label = "Economic crash of 2008 (the larger chasm)", size = 5)+
  theme_bw()+
  scale_y_continuous(labels = comma) -> p3

ggplot(data = Inactive_player, aes(x = Date_numeric, y = total_count)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("# of inactives")+
  # geom_segment(aes(x=as.Date("2004-06-01"), xend=as.Date("2008-06-01"), y=140000, yend=55000), 
  #              arrow = arrow(length = unit(.5, "cm")), size = 2)+
  # geom_segment(aes(x=as.Date("2004-06-01"), xend=as.Date("2002-07-01"), y=140000, yend=35000), 
  #              arrow = arrow(length = unit(.5, "cm")), size = 2)+
  # annotate("text", x = as.Date("2005-01-01"), y = 155000, 
  #          label = "Is this corrupted data?", size = 5)+
  theme_bw()+
  scale_y_continuous(labels = comma) -> p4

plot_grid(p1, p2, p3, p4, labels = c("A", "B", "C", "D"))
```

# Rating stability over time (misleading)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
ggplot(data = Active_player, aes(x = Date_numeric, y = avg_rating)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("Average of Actives")+
  theme_bw() -> p5

ggplot(data = Inactive_player, aes(x = Date_numeric, y = avg_rating)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("Average of Inactives")+
  theme_bw() -> p6

ggplot(data = Active_player, aes(x = Date_numeric, y = sd_rating)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("Actives SD")+
  theme_bw() -> p7

ggplot(data = Inactive_player, aes(x = Date_numeric, y = sd_rating)) + 
  geom_line(color = "#FC4E07", size = 1)+
  xlab("Year")+
  ylab("Inactives SD")+
  theme_bw() -> p8

plot_grid(p5, p6, p7, p8, labels = c("A", "B", "C", "D"))

```



# Which countries have seen the greatest changes in player counts?

```{r, echo = FALSE, cache=TRUE}
Country_diff%>%
filter(Country %in% Notable)%>%
ggplot() +
geom_line(aes(x = Date_numeric, y = Diff, colour = Country))+
theme_bw()+
ggtitle("Gained/Lost over time")+
xlab("Year")+
ylab("Gained/Lost")
```

# Titled player count over time


```{r, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
titled%>%
ggplot(aes(x=Date_numeric, y= n, group=Title, color=Title)) +
geom_line(size = 1.5)+
xlab("Year")-> p9

titles_group%>%
ggplot(aes(x=Date_numeric, y= n, group=w_titles, color=w_titles)) +
geom_line(size = 1.5)+
xlab("Year") -> p10

titles_group %>%
group_by(w_titles) %>%
mutate(Diff = n - lag(n))%>%
ggplot(aes(x=Date_numeric, y= Diff, group=w_titles, color=w_titles)) +
geom_line(size = 1.5)+
xlab("Year") -> p11

Games%>%
ggplot() +
geom_line(aes(x=Date_numeric, y= roll), size = 1.5, color = "red")+
theme_bw()+
xlab("Year") -> p12


plot_grid(p9, p10, p11, p12, labels = c("A", "B", "C", "D"))
```



```{r, echo=FALSE, message=FALSE, echo=FALSE, cache=TRUE}

titled%>%
filter(Title %in% c("CM", "FM", "IM", "GM"))%>%
ggplot(aes(x= Country, y =n))+
    geom_bar(stat ="identity")+
    coord_flip()+
    xlab("Country")+
    ylab("Counts")+
    facet_wrap(~Title)+
    theme_bw()+
    theme(axis.text=element_text(size=6))

```



```{r, message=FALSE, warning=FALSE, echo=FALSE, cache = TRUE}
strongest%>%
ggplot(aes(x= Country, y= average_rating))+
    geom_bar(stat ="identity")+
    coord_flip()+
    xlab("Country")+
    ylab("Average Ratng")+
    ggtitle("Highest rated age groups by country")+
    facet_wrap(~Age_groups, ncol = 2)+
    theme_bw()+
    theme(axis.text=element_text(size=7))
```



```{r, echo=FALSE, cache=TRUE}

dec19_titled%>%
ggplot(aes(Age_Birthday, Rating, color=Title)) +
  geom_point(alpha = .3) +
  scale_fill_brewer(palette="Set1") +
  theme(legend.position = "right")+
  theme_bw()+
  ggtitle("Age vs Rating of different titles for December 2019")+
  xlab("Age")

```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
# FIDE%>%
# group_by(Date_numeric)%>%
# tally()%>%
# .$Date_numeric%>%
# .[seq(1, length(.), by = 1)] -> years_increment
# 
# transition <- FIDE%>%
#               filter(Date_numeric %in% years_increment, 
#                      !(Age_Birthday < 1850),
#                      Rating < 2900,
#                      Rating > 1000,
#                      Activity %in% Active,
#                      Sex %in% c("F", "M"))%>%
#               select(Rating, Sex, Date_numeric)%>%
#               arrange(Date_numeric)
# 
# theme_set(theme_bw())
# transition%>%
# ggplot() +
# geom_density(aes(x = Rating, group=Sex, fill=Sex), alpha = .3)+
# labs(title = 'Year: {frame_time}')+
# transition_time(Date_numeric)

# library(ggplot2)
# library(gganimate)
# library(tidyverse)
# 
# fill_in = data.frame(value = c(), year = c())
# for (i in seq(1, 300, by = 10)){
#   value = rnorm(i*20)
#   year = rep(i, length(value))+2000
#   stuff = data.frame(value = value, year = year)
#   fill_in = rbind(fill_in, stuff)
# }
# 
# 
# ggplot(data = fill_in, mapping = aes(x=value, fill=as.factor(year)))+ 
# geom_density(alpha = .3)
# 
# 
# 
# ggplot(fill_in, aes(value)) +
# geom_density(alpha = .3)+
# labs(title = 'Year: {frame_time}') +
# transition_time(year)


# rm(FIDE)

# ggplot(NOV19,aes(x=Age,y=Rating))+
# stat_density_2d(aes(fill = ..level..), geom="polygon")+
# theme_bw()
#
#
# nov19_titled <- NOV19%>%
#                 filter(!Title %in% c(""), Womens_Title == "")
# 
# ggplot(nov19_titled,aes(Age, Rating, color=Title)) +
#   geom_point(alpha = .3) +
#   scale_fill_brewer(palette="Set1") +
#   theme(legend.position = "right")+
#   theme_bw()+
#   ggtitle("Age vs Rating of different titles for November 2019")
#
# library(gapminder)
# gapminder%>%
# ggplot(aes(x= gdpPercap, y = lifeExp,
#            size = pop, colour = country)) +
# geom_point(alpha = 0.7, show.legend = FALSE) +
# scale_colour_manual(values = country_colors) +
# scale_size(range = c(2, 12)) +
# scale_x_log10() +
# facet_wrap(~continent) +
# labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
# transition_time(year) +
# ease_aes('linear')
#
# FIDE%>%
# filter(Rating > 2830)%>%
# .$Name%>%
# unique() -> top_player
# 
# #Visualize the data
# WC_caliber_players <- FIDE%>%
#   filter(Name %in% top_player, Activity == "")%>%
#   select(Name, Rating, Date)%>%
#   arrange(Name, Date)
# 
# 
# dygraphed <- WC_caliber_players %>%
#              spread(key = Name, value = Rating)%>%
#              xts(.[,which(colnames(.)!= "Date")],order.by =  .$Date)
# 
# dygraph(dygraphed, main = "Player's rating over Time") %>%
#   dyOptions(drawPoints = TRUE, pointSize = 2, axisLineWidth = 4) %>%
#   dyAxis("y", label = "Rating", valueRange = c(1900, 3200))%>%
#   dyRangeSelector()%>%
#   dyLegend(width = 400)
#
# data <- fread("SEP19.csv", sep = "*", data.table = FALSE)
#
#
# library(ggplot2)
# data%>%
# mutate(Rating = as.numeric(NOV19))%>%
# filter(Flag == "wi")%>%
# na.omit()%>%
# ggplot(aes_string(x="Rating"))+
# geom_density(size=2, alpha=.4)+
# geom_histogram(aes(y = ..density..), bins = 50, col= "red")+ 
# labs(title="Histogram overlayed with Density curve") +
# labs(x="Rating", y="Percentage of players in population")

# cl<-makeCluster(detectCores()) 
# registerDoParallel(cl)
# temp_short = proper_temp[1:5]
# FIDE<-foreach(i=proper_temp, .export = "fread") %dopar% {
# t <- fread(i, sep = "*", data.table = FALSE, strip.white = TRUE, 
# blank.lines.skip = TRUE)
#                                                                  }
# stopCluster(cl)

#Put datasets in list
# FIDE <- mget(ls(pattern = "[0-9][0-9]-[0-9][0-9]"))
# rm(list=setdiff(ls(), c("FIDE", "ptm")))

# #Help rename columns in the data
# vector_months <- c(month.abb, tolower(month.abb),toupper(month.abb))
# string = ""
# for (i in 1:length(vector_months)){
# if (i == 1){string = vector_months[i]}
# else if (i > 1) {string = paste(string, vector_months[i], sep = "|")}
# }
# string = paste(string, "RATING", sep = "|")

# names(FIDE) <- month_num
# 
# old = c("c", "wc", "WC", "wg", "WF", "wf", "g", "m", "f", "wm", "gm" )
# new = c("CM", "WCM", "WCM", "WGM", "WFM", "WFM", "GM", "IM", "FM", "WIM", "GM")
# 
# #Insert month column
# for(i in 1:length(FIDE)){
#   colnames(FIDE[[i]])[grepl("Name|NAME|name", colnames(FIDE[[i]]))] <- "Name"
#   colnames(FIDE[[i]])[grepl("NUMBER", colnames(FIDE[[i]]))] <- "ID_Number"
#   colnames(FIDE[[i]])[grepl("Fed|FED|COUNTRY", colnames(FIDE[[i]]))] <- "Country"
#   colnames(FIDE[[i]])[grepl("Gms|GAMES|GM|Game|GAME", colnames(FIDE[[i]]))] <- "Games"
#   colnames(FIDE[[i]])[grepl("K", colnames(FIDE[[i]]))] <- "K_factor"
#   colnames(FIDE[[i]])[grepl("FLAG|Flag|flag", colnames(FIDE[[i]]))] <- "Activity"
#   colnames(FIDE[[i]])[colnames(FIDE[[i]]) %in% c("Wtit","wtit","WTIT", "WTit")] <- "Womens_Title"
#   colnames(FIDE[[i]])[colnames(FIDE[[i]]) %in% c("TITLE","Title","title","Tit")] <- "Title"
#   colnames(FIDE[[i]])[grepl(string, colnames(FIDE[[i]]))] <- "Rating"
#   colnames(FIDE[[i]])[grepl("Born|Age|age|BIRTHDAY|B-day|Bday", colnames(FIDE[[i]]))] <- "Age_Birthday"
#   colnames(FIDE[[i]])[grepl("SEX", colnames(FIDE[[i]]))] <- "Sex"
#   colnames(FIDE[[i]])[grepl("FOA", colnames(FIDE[[i]]))] <- "FIDE_Online_Arena"
#   colnames(FIDE[[i]])[grepl("OTit", colnames(FIDE[[i]]))] <- "Other_Titles"
#   FIDE[[i]] <-  FIDE[[i]] %>%
#                 mutate(Date = as.POSIXct(names(FIDE)[i], format="%Y-%m-%d"),
#                        Date_numeric = year(Date)+yday(Date)/366,
#                        Rating = as.numeric(Rating),
#                        Title= c(new, Title)[match(Title, c(old, Title))])%>%
#                 filter(!Country %in% c("Fed", "Col"))
# }



# FIDE <- rbindlist(FIDE, fill = TRUE)%>%
        # select(-V1, -ID_Number)
```
