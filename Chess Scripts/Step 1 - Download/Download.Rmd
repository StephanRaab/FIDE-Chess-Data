---
title: "FIDE Chess Download"
author: "Anuj Dahiya"
date: "11/16/2019"
output:
  pdf_document: default
  html_document: default
---


# Introduction

The purpose of this document is to show how I downloaded all of the standard rating files from the FIDE organizations website.


# Set up working directory

Before proceeding, we need to set up a working directory to store all of the downloaded files. Make sure to have an empty folder you can dump the files into. I've created a `Downloaded files` subfolder within the folder of this `.Rmd` document.

```{r}
knitr::opts_knit$set(root.dir = "~/GitHub/FIDE/Chess Scripts/Step 1 - Download/Downloaded files")
```

# Import libraries

I don't think any packages are necessary to download any of the files. Still though, I use `knitr` and `dplyr` to display a table of urls that we will download later on.

```{r, message=FALSE, warning=FALSE}
library(knitr)
library(dplyr)
```


# FIDE file format


R's default is to adjust all numbers, beginning with 0, and truncatte the leading zeros. 

Below is used to grab the most up to date available data (it should be the current month).


```{r}
year_vector <- as.character(1:as.numeric(substr(Sys.Date(), 3, 4)))
month_vector <- tolower(substr(month.name, 1, 3))
url_vector = url_vect_destfile = rep(0, length(month_vector)*length(year_vector))

latest <- format(Sys.Date(), format="%b%Y")
latest <- paste(tolower(substr(latest, 1, 1)), substr(latest, 2, 3), substr(latest, nchar(latest)-1, nchar(latest)), "frl.zip", sep = "")

latest
```

```{r}
for(i in 1:length(year_vector)){
  if(nchar(year_vector[i]) == 1){
    year_vector[i] = paste("0", year_vector[i], sep = "")
  }
}

year_vector
```

Below, we put it all together using a somewhat ugly for loop, but it accomplishes our job nicely to create the urls we desire. Note that in August 2014 (which explains the `else if` statement at the 140th iteration), FIDE added an extra word, "standard_" to the URLs to be downloaded from. 

```{r}
for(i in seq_along(year_vector)){
  for(j in seq_along(month_vector)){
    if(12*(i-1)+j <= 140){
      url_vector[12*(i-1)+j] = paste("http://ratings.fide.com/download/", month_vector[j], year_vector[i], "frl.zip", sep = "")
    }
    else if(12*(i-1)+j > 140){
      url_vector[12*(i-1)+j] = paste("http://ratings.fide.com/download/standard_", month_vector[j], year_vector[i], "frl.zip", sep = "")
    }
    url_vect_destfile[12*(i-1)+j] <- substr(url_vector[12*(i-1)+j], nchar(url_vector[12*(i-1)+j])- 11 , nchar(url_vector[12*(i-1)+j]))
  }
}

url_vect_destfile <- url_vect_destfile[1:which(url_vect_destfile == latest)]
url_vector <- url_vector[1:which(url_vect_destfile == latest)]
```



```{r, echo=FALSE}
data.frame(URL = url_vector,
           Destination = url_vect_destfile)%>%
slice(c(1:5, (n()-4):n()))%>% #first/last 5 observations
kable()
```



```{r, eval=FALSE}
rm(list=setdiff(ls(), c("url_vector", "url_vect_destfile")))

download_all <- function(link, dest){
  if (!file.exists(dest)) {
    tryCatch({
      download.file(link, dest, method="auto", quiet = TRUE) 
    }, error=function(e){})
  }
}


old <- getOption("warn"); options(warn = -1)
invisible(mapply(download_all, url_vector, url_vect_destfile))
options(warn = old)
```


# Cleaning 

Some brief housecleaning is taken care of below After the step below, you should only have text files in the directory you set at the beginning. All that's done below is unzipping the `.zip` files and deleting the `.zip` files.

```{r}
invisible(sapply(list.files(pattern = "*.zip"), function(x) unzip(x, exdir = getwd())))

unlink(list.files(pattern = "*.zip"))
```

Lastly, we can verify what is in our directory.


```{r}
list.files(pattern = "*.txt")%>%
head()
```

Onto Step #2 now.
