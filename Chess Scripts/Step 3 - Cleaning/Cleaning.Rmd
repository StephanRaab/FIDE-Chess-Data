---
title: "Cleaning"
author: "Anuj Dahiya"
date: "12/23/2019"
output: pdf_document
---



The purpose of this document is to make use of the data stored within the `FIDE` data folder. 

Before beginning, we need to import several packages that help run the code below.




# Access the data

The data is stored in a path we have to manipulate to get to.


```{r}
path = "~/GitHub/FIDE/Chess Scripts/Step 2 - Reformat/Data csvs/"

knitr::opts_knit$set(root.dir = path)

temp = list.files(path = path, 
                  pattern = "\\.csv?")

head(temp)
```



# Create functions to rename datasets

Below, I define a few functions that help us rename the datasets eventually

```{r}
num <- function(x) match(tolower(x), tolower(month.abb))
month <- function(x){return(substr(x, 1, 3))}
add_zero <- function(x){if (x <= 9){x = paste("0", x, sep = "")}; return(x)}
```

# Get the month number of all of the files in the dataset

Below, I rename create the variables names when they are imported in memory.

```{r}
temp%>%
sapply(month)%>%
sapply(num)%>%
sapply(add_zero)%>%
paste("20", substr(temp, 4, 5), "-", ., "-", "01", sep = "")-> month_num

head(month_num)
```

We can see that the datasets correspond to dates on which the is recorded.

# Import all datasets

Due to the data being quite large, your RAM may be used heavily. 


```{r}
proper_temp <- paste(path, temp, sep = "")


for(i in 1:length(proper_temp)) {
assign(month_num[i], fread(proper_temp[i], sep = "*", data.table = FALSE, 
                           strip.white = TRUE, blank.lines.skip = TRUE))
}

```


```{r}
FIDE <- mget(ls(pattern = "[0-9][0-9]-[0-9][0-9]"))

rm(list=setdiff(ls(), c("FIDE", "month_num", "path", "proper_temp", "temp")))

#Help rename columns in the data
vector_months <- c(month.abb, tolower(month.abb),toupper(month.abb))
string = ""
for (i in 1:length(vector_months)){
if (i == 1){string = vector_months[i]}
else if (i > 1) {string = paste(string, vector_months[i], sep = "|")}
}

string = paste(string, "RATING", sep = "|")
new = c("CM", "WCM", "WCM", "WGM", "WFM", "WFM", "GM", "IM", "FM", "WIM", "GM")
old = c("c", "wc", "WC", "wg", "WF", "wf", "g", "m", "f", "wm", "gm" )

dates = as.Date(names(FIDE))

months_vec <- months(dates)%>%
              toupper()%>%
              substr(., 1, 3) 

year_vec <- year(dates)%>%
            as.character()%>%
            substr(3,4)

files <- paste(months_vec, year_vec, ".csv", sep = "")
```



```{r, results='hide', warning=FALSE, message=FALSE}

#Insert month column
for(i in 1:length(FIDE)){
  colnames(FIDE[[i]])[grepl("Name|NAME|name", colnames(FIDE[[i]]))] <- "Name"
  colnames(FIDE[[i]])[grepl("NUMBER", colnames(FIDE[[i]]))] <- "ID_Number"
  colnames(FIDE[[i]])[grepl("Fed|FED|COUNTRY", colnames(FIDE[[i]]))] <- "Country"
  colnames(FIDE[[i]])[grepl("Gms|GAMES|GM|Game|GAME", colnames(FIDE[[i]]))] <- "Games"
  colnames(FIDE[[i]])[grepl("K", colnames(FIDE[[i]]))] <- "K_factor"
  colnames(FIDE[[i]])[grepl("FLAG|Flag|flag", colnames(FIDE[[i]]))] <- "Activity"
  colnames(FIDE[[i]])[colnames(FIDE[[i]]) %in% c("Wtit","wtit","WTIT", "WTit")] <- "Womens_Title"
  colnames(FIDE[[i]])[colnames(FIDE[[i]]) %in% c("TITLE","Title","title","Tit")] <- "Title"
  colnames(FIDE[[i]])[grepl(string, colnames(FIDE[[i]]))] <- "Rating"
  colnames(FIDE[[i]])[grepl("Born|Age|age|BIRTHDAY|B-day|Bday", colnames(FIDE[[i]]))] <- "Age_Birthday"
  colnames(FIDE[[i]])[grepl("SEX", colnames(FIDE[[i]]))] <- "Sex"
  colnames(FIDE[[i]])[grepl("FOA", colnames(FIDE[[i]]))] <- "FIDE_Online_Arena"
  colnames(FIDE[[i]])[grepl("OTit", colnames(FIDE[[i]]))] <- "Other_Titles"
  FIDE[[i]] %>%
  mutate(Date = as.POSIXct(names(FIDE)[i], format="%Y-%m-%d"),
         Date_numeric = year(Date)+yday(Date)/366,
         Rating = as.numeric(Rating),
         Title= c(new, Title)[match(Title, c(old, Title))])%>%
         filter(!Country %in% c("Fed", "Col"))%>%
         select(-one_of("V1"))%>%
  fwrite(. , file = paste(path, files[i], sep = ""), sep = "*")
}
```

